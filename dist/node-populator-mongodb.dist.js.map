{"version":3,"sources":["index.js"],"names":["bunyan","path","LOG","name","__filename","dbQueryCounter","maxDbIdleTime","closeIdleDb","connection","previousCounter","checker","setInterval","close","clearInterval","PopulatorMongo","host","port","dbname","resourcesPath","extension","collections","coll","db","Db","Server","p1","open","then","stack","map","p","collection","dropIndexes","catch","push","Promise","all","drop","insertMany","require","console","log"],"mappings":";;;;;;AAAA;;;;AACA;;IACYA;;AACZ;;;;AACA;;IACYC;;;;;;AAEZ;;;;;;;;;;;;;;;;;;;;;;;;;AAyBA;;;;;;;;AAQA;AACA;AACA,IAAMC,MAAM,0BAAa,EAACC,MAAMC,UAAP,EAAb,CAAZ;;AAEA,IAAIC,iBAAiB,CAArB;AACA,IAAIC,gBAAgB,IAApB,EAA0B;;AAE1B,IAAIC,cAAc,SAAdA,WAAc,CAAUC,UAAV,EAAsB;AACtC,MAAIC,kBAAkB,CAAtB;AACA,MAAIC,UAAUC,YAAY,YAAY;AACpC,QAAIF,mBAAmBJ,cAAnB,IAAqCA,kBAAkB,CAA3D,EAA8D;AAC5DG,iBAAWI,KAAX;AACAC,oBAAcN,WAAd;AACD,KAHD,MAGO;AACLE,wBAAkBJ,cAAlB;AACD;AACF,GAPa,EAOXC,aAPW,CAAd;AAQD,CAVD;;AAYA;;;;AAIA,SAASQ,cAAT,CAAwBC,IAAxB,EAA8BC,IAA9B,EAAoCC,MAApC,EAA4CC,aAA5C,EAA2DC,SAA3D,EAAsEC,WAAtE,EAAmF;AACjF,MAAIC,OAAO,IAAX;AACA,MAAIC,KAAK,IAAI,kBAAQC,EAAZ,CAAeN,MAAf,EAAuB,IAAI,kBAAQO,MAAZ,CAAmBT,IAAnB,EAAyBC,IAAzB,CAAvB,CAAT;AACA,MAAIS,KAAKH,GAAGI,IAAH,EAAT;AACAD,OAAKA,GAAGE,IAAH,CAAQ,UAACL,EAAD,EAAQ;AACnBA,SAAKA,EAAL;AACD,GAFI,CAAL;AAGAG,OAAKA,GAAGE,IAAH,CAAQ,YAAM;AACjB,QAAMC,QAAQ,EAAd;AACAR,gBAAYS,GAAZ,CAAgB,UAAC1B,IAAD,EAAU;AACxB,UAAI2B,IAAIR,GAAGS,UAAH,CAAc5B,IAAd,EAAoB6B,WAApB,EAAR;AACAF,UAAIA,EAAEG,KAAF,CAAQ,eAAO,CAClB,CADG,CAAJ;AAEAL,YAAMM,IAAN,CAAWJ,CAAX;AACD,KALD;AAMA,WAAOK,QAAQC,GAAR,CAAYR,KAAZ,CAAP;AACD,GATI,CAAL;AAUAH,OAAKA,GAAGE,IAAH,CAAQ,YAAM;AACjB,QAAMC,QAAQ,EAAd;AACAR,gBAAYS,GAAZ,CAAgB,UAAC1B,IAAD,EAAU;AACxB,UAAI2B,IAAIR,GAAGS,UAAH,CAAc5B,IAAd,EAAoBkC,IAApB,EAAR;AACAP,UAAIA,EAAEG,KAAF,CAAQ,eAAO,CAClB,CADG,CAAJ;AAEAL,YAAMM,IAAN,CAAWJ,CAAX;AACD,KALD;AAMA,WAAOK,QAAQC,GAAR,CAAYR,KAAZ,CAAP;AACD,GATI,CAAL;AAUAH,OAAKA,GAAGE,IAAH,CAAQ,YAAM;AACjB,QAAMC,QAAQ,EAAd;AACAR,gBAAYS,GAAZ,CAAgB,UAAC1B,IAAD,EAAU;AACtB,UAAM2B,IAAIR,GAAGS,UAAH,CAAc5B,IAAd,EAAoBmC,UAApB,CAA+BC,QAAQ,gBAAKrB,aAAL,EAAoBf,OAAOgB,SAA3B,CAAR,CAA/B,CAAV;AACAS,YAAMM,IAAN,CAAWJ,CAAX;AAEH,KAJD;AAKA,WAAOK,QAAQC,GAAR,CAAYR,KAAZ,CAAP;AACD,GARI,CAAL;AASAH,OAAKA,GAAGE,IAAH,CAAQ,YAAM;AACjBpB,gBAAYe,EAAZ;AACA,WAAOA,GAAGV,KAAH,EAAP;AACD,GAHI,CAAL;;AAMAa,KAAGQ,KAAH,CAAS;AAAA,WAAOO,QAAQC,GAAf;AAAA,GAAT;AACA,SAAOhB,EAAP;AACD;;kBAEcX","file":"node-populator-mongodb.dist.js","sourcesContent":["import util from 'util';\nimport { createLogger } from 'bunyan';\nimport * as bunyan from 'bunyan';\nimport mongodb from 'mongodb';\nimport { join } from 'path';\nimport * as path from 'path';\n\n/**\n * The MIT License (MIT)\n *\n * Copyright (c) 2016 9 Février\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\n\n/**\n * # Node Populator for MongoDB: entry point.\n *\n * (c) 2016, 9 Février <contact@9fevrier.com>\n *\n * This file is a part of Node Populator for MongoDB.\n */\n\n// import * as promisifyAll from 'es6-promisify-all';\n// The logger.\nconst LOG = createLogger({name: __filename});\n\nvar dbQueryCounter = 0;\nvar maxDbIdleTime = 5000; //maximum db idle time\n\nvar closeIdleDb = function (connection) {\n  var previousCounter = 0;\n  var checker = setInterval(function () {\n    if (previousCounter == dbQueryCounter && dbQueryCounter != 0) {\n      connection.close();\n      clearInterval(closeIdleDb);\n    } else {\n      previousCounter = dbQueryCounter;\n    }\n  }, maxDbIdleTime);\n};\n\n/**\n * # Helper for MongoDB populating\n *\n */\nfunction PopulatorMongo(host, port, dbname, resourcesPath, extension, collections) {\n  let coll = null;\n  let db = new mongodb.Db(dbname, new mongodb.Server(host, port));\n  let p1 = db.open();\n  p1 = p1.then((db) => {\n    db = db;\n  });\n  p1 = p1.then(() => {\n    const stack = [];\n    collections.map((name) => {\n      let p = db.collection(name).dropIndexes();\n      p = p.catch(err => {\n      });\n      stack.push(p);\n    });\n    return Promise.all(stack);\n  });\n  p1 = p1.then(() => {\n    const stack = [];\n    collections.map((name) => {\n      let p = db.collection(name).drop();\n      p = p.catch(err => {\n      });\n      stack.push(p);\n    });\n    return Promise.all(stack);\n  });\n  p1 = p1.then(() => {\n    const stack = [];\n    collections.map((name) => {\n        const p = db.collection(name).insertMany(require(join(resourcesPath, name + extension)));\n        stack.push(p);\n\n    });\n    return Promise.all(stack);\n  });\n  p1 = p1.then(() => {\n    closeIdleDb(db);\n    return db.close();\n  });\n\n\n  p1.catch(err => console.log);\n  return p1;\n}\n\nexport default PopulatorMongo;\n"],"sourceRoot":"/home/fmichaud/.node_modules/node-populator-mongodb/.gulp/tasks/src"}